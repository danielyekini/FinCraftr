name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

jobs:
  # Test C++ library builds
  cpp-build:
    name: C++ Build (${{ matrix.os }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Debug, Release]
        include:
          - os: ubuntu-latest
            generator: "Unix Makefiles"
          - os: windows-latest
            generator: "Visual Studio 17 2022"
          - os: macos-latest
            generator: "Unix Makefiles"

    steps:
    - uses: actions/checkout@v4

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.20'

    - name: Configure CMake (Header-only)
      run: |
        cmake -B build-header-only -G "${{ matrix.generator }}" \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DFINCRAFTR_HEADER_ONLY=ON \
              -DFINCRAFTR_BUILD_SHARED=OFF \
              -DFINCRAFTR_BUILD_STATIC=OFF

    - name: Build (Header-only)
      run: cmake --build build-header-only --config ${{ matrix.build_type }}

    - name: Install (Header-only)
      run: cmake --install build-header-only --config ${{ matrix.build_type }} --prefix install-header-only

    - name: Configure CMake (Compiled)
      run: |
        cmake -B build-compiled -G "${{ matrix.generator }}" \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DFINCRAFTR_HEADER_ONLY=OFF \
              -DFINCRAFTR_BUILD_SHARED=ON \
              -DFINCRAFTR_BUILD_STATIC=ON

    - name: Build (Compiled)
      run: cmake --build build-compiled --config ${{ matrix.build_type }}

    - name: Install (Compiled)
      run: cmake --install build-compiled --config ${{ matrix.build_type }} --prefix install-compiled

    - name: Test CMake find_package (Header-only)
      shell: bash
      run: |
        cat > test_find_package.cpp << 'EOF'
        #include <fincraftr/equity/returns.hpp>
        #include <iostream>
        int main() {
            double result = fc::equity::return_simple(105.0, 100.0);
            std::cout << "Simple return: " << result << std::endl;
            return 0;
        }
        EOF
        
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.20)
        project(test_fincraftr)
        set(CMAKE_CXX_STANDARD 20)
        find_package(fincraftr REQUIRED PATHS install-header-only)
        add_executable(test_app test_find_package.cpp)
        target_link_libraries(test_app PRIVATE fincraftr::fincraftr)
        EOF
        
        cmake -B build-test -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        cmake --build build-test --config ${{ matrix.build_type }}

  # Test Python package builds
  python-build:
    name: Python Build (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.20'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel pybind11[global] cmake ninja

    - name: Build Python package
      run: |
        python -m build

    - name: Install and test package
      run: |
        pip install dist/*.whl
        python -c "
        import fincraftr as fc
        print('Testing fincraftr...')
        result = fc.return_simple(105.0, 100.0)
        print(f'Simple return: {result}')
        assert abs(result - 0.05) < 1e-10, f'Expected 0.05, got {result}'
        print('✓ Basic test passed')
        
        # Test module access
        result2 = fc.equity.return_simple(110.0, 100.0)
        print(f'Module access test: {result2}')
        assert abs(result2 - 0.10) < 1e-10, f'Expected 0.10, got {result2}'
        print('✓ Module access test passed')
        
        # Test other functions
        compound_result = fc.rates.compound_discrete(1000.0, 0.05, 12, 1.0)
        print(f'Compound interest: {compound_result}')
        print('✓ All tests passed')
        "

    - name: Upload wheel artifacts
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: python-wheels
        path: dist/*.whl

  # Test vcpkg configuration
  vcpkg-test:
    name: vcpkg Configuration Test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.20'

    - name: Validate vcpkg manifest
      run: |
        # Test that vcpkg.json is valid JSON and has required fields
        python -c "
        import json
        with open('vcpkg.json') as f:
            data = json.load(f)
        required = ['name', 'version', 'description', 'homepage', 'license']
        missing = [f for f in required if f not in data]
        if missing:
            raise ValueError(f'Missing required fields: {missing}')
        print(f'✅ vcpkg.json is valid with all required fields')
        print(f'Package: {data[\"name\"]} v{data[\"version\"]}')
        "

    - name: Test CMake without vcpkg
      run: |
        # Test that CMake files work without vcpkg
        cmake -B build-vcpkg -DFINCRAFTR_HEADER_ONLY=ON
        cmake --build build-vcpkg
        echo "✅ CMake builds successfully (ready for vcpkg integration)"

  # Documentation build test
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install documentation dependencies
      run: |
        pip install sphinx sphinx-rtd-theme myst-parser

    - name: Test documentation structure
      run: |
        echo "Documentation structure validated"
        # Future: Add actual Sphinx build when docs are created
